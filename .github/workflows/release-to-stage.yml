# File: .github/workflows/release-to-stage.yml
name: "ðŸ“¦ Release to Stage"
on:
  workflow_dispatch:
    inputs:
      title:
        description: 'PR title'
        required: true
      description:
        description: 'PR description (Confluence link, notesâ€¦)'
        required: false

permissions:
  contents: read         # for listing commits
  pull-requests: write   # to create the PR

jobs:
  release:
    runs-on: ubuntu-latest
    steps:

      # 1. Checkout repo so we can run gh and list commits
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: true

      # 2. Create a PR from develop â†’ stage with gh CLI
      - name: Create developâ†’stage PR
        id: create_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_json=$(gh pr create \
            --title "${{ github.event.inputs.title }}" \
            --body "${{ github.event.inputs.description }}" \
            --base stage \
            --head develop \
            --json number,url)
          number=$(jq -r .number <<<"$pr_json")
          url=$(jq -r .url    <<<"$pr_json")
          echo "number=$number" >> $GITHUB_OUTPUT
          echo "url=$url"       >> $GITHUB_OUTPUT

      # 3. List unique commit-author emails on that PR
      - name: Get PR commit emails
        id: authors
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const n = Number('${{ steps.create_pr.outputs.number }}');
            const { data: commits } = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              pull_number: n
            });
            return [...new Set(commits.map(c => c.commit.author.email))];

      # 4. Map emails â†’ Slack IDs (fallback to raw email)
      - name: Map to Slack IDs
        id: slack_ids
        run: |
          map="$(cat .github/slack-map.json)"
          mentions=()
          for email in ${{ steps.authors.outputs.result }}; do
            id=$(jq -r --arg e "$email" '.[$e] // empty' <<<"$map")
            if [[ -n "$id" ]]; then
              mentions+=( "<@$id>" )
            else
              mentions+=( "$email" )
            fi
          done
          echo "ids=${mentions[*]}" >> $GITHUB_OUTPUT

      # 5. Notify Slack via your single Workflow
      - name: Notify Slack via Workflow
        if: steps.create_pr.outputs.number
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_RELEASE_WORKFLOW_URL }}
          EVENT:        "Release to Stage"
          TITLE:        "${{ github.event.inputs.title }}"
          MESSAGE:      |
                          â€¢ PR: <${{ steps.create_pr.outputs.url }}|View on GitHub>
                          â€¢ Description: ${{ github.event.inputs.description || 'â€“ none â€“' }}
          MENTIONS:     ${{ steps.slack_ids.outputs.ids }}
        run: |
          jq -n \
            --arg event    "$EVENT" \
            --arg title    "$TITLE" \
            --arg message  "$MESSAGE" \
            --arg mentions "$MENTIONS" \
            '{event: $event, title: $title, message: $message, mentions: $mentions}' \
          | curl -X POST -H "Content-Type: application/json" \
                 --data @- \
                 "$SLACK_WEBHOOK"
