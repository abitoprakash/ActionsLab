name: "Create develop -> Stage PR"

permissions:
  contents: read
  pull-requests: write

on:
  workflow_dispatch:
    inputs:
      pr_title:
        description: "Pullâ€‘request title"
        required: true
        type: string
      pr_body:
        description: "Optional PR description (appears in GitHub)"
        required: false
        type: string

env:
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_RELEASE_WORKFLOW_URL }}
  GH_TOKEN:          ${{ secrets.GITHUB_TOKEN }}

jobs:
  create_dev_stage_pr:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Compose PR description
      id: prdesc
      shell: bash
      run: |
        WF_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        if [[ -n "${{ github.event.inputs.pr_body }}" ]]; then
          DESC="${{ github.event.inputs.pr_body }}\n\nâ€”\nCreated via workflow run: ${WF_URL}"
        else
          DESC="Automatically created PR.\nWorkflow run â†’ ${WF_URL}"
        fi
        # Set output safely for multiâ€‘line text
        {
          echo 'text<<EOF'
          echo -e "$DESC"
          echo 'EOF'
        } >>"$GITHUB_OUTPUT"

    - name: Create PR
      id: pr
      shell: bash
      run: |
        PR_URL=$(gh pr create \
                   --head develop \
                   --base stage  \
                   --title "${{ github.event.inputs.pr_title }}" \
                   --body  "${{ steps.prdesc.outputs.text }}" | tail -n1)
        echo "url=$PR_URL"        >>"$GITHUB_OUTPUT"
        echo "number=${PR_URL##*/}" >>"$GITHUB_OUTPUT"

    - name: Add reviewers
      shell: bash
      run: |
        COMMITS=$(gh api repos/${{ github.repository }}/pulls/${{ steps.pr.outputs.number }}/commits)
        LOGINS=$(jq -r '.[] | .author.login' <<<"$COMMITS" | grep -v null | sort -u | tr '\n' ',' | sed 's/,$//')
        if [[ -n "$LOGINS" ]]; then
          gh pr edit ${{ steps.pr.outputs.number }} --add-reviewer "$LOGINS"
        fi

    - name: Notify Slack
      shell: bash
      run: |
        title="ðŸš€ Develop â†’ Stage PR #${{ steps.pr.outputs.number }} created"
        body="Workflow triggered by: ${{ github.actor }}"
        link="${{ steps.pr.outputs.url }}"
        linkLabel="View PR"

        jq -n \
          --arg title "$title" \
          --arg body "$body" \
          --arg link "$link" \
          --arg linkLabel "$linkLabel" \
          '{title:$title,body:$body,link:$link,linkLabel:$linkLabel}' |
        curl -s -X POST -H 'Content-Type: application/json' \
             --data @- "$SLACK_WEBHOOK_URL"
