name: "Create develop -> Stage PR"

permissions:
  contents: read
  pull-requests: write

on:
  workflow_dispatch:
    inputs:
      pr_title:
        description: "Pullâ€‘request title"
        required: true
        type: string

env:
  SLACK_RELEASE_WORKFLOW_URL: ${{ secrets.SLACK_RELEASE_WORKFLOW_URL }}
  GH_TOKEN:                    ${{ secrets.GITHUB_TOKEN }}

jobs:
  promote:
    runs-on: ubuntu-latest

    steps:
      # 1â€† Get the repo (includes slack-user-map.json)
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      # 2â€† Open the PR develop â†’ stage
      - name: Open pull request
        id: pr
        run: |
          url=$(gh pr create \
                 --head develop --base stage \
                 --title "${{ github.event.inputs.pr_title }}" \
                 --body  "Autoâ€‘generated promote PR.")
          echo "url=$url" >>"$GITHUB_OUTPUT"
          echo "number=${url##*/}" >>"$GITHUB_OUTPUT"

      # 3â€† Collect commit authors (usernames + eâ€‘mails)
      - name: Gather commit authors
        id: authors
        run: |
          commits=$(gh api repos/${{ github.repository }}/pulls/${{ steps.pr.outputs.number }}/commits)
          ids=$(jq -r '.[] | .author.login?, .commit.author.email?' <<<"$commits" | grep -v null | sort -u)
          echo "all=$(echo "$ids" | tr '\n' ',' | sed 's/,$//')" >>"$GITHUB_OUTPUT"

      # 4â€† Map to Slack mentions (uses .github/slack-user-map.json)
      - name: Map to Slack mentions
        id: mentions
        run: |
          mapfile -t ids < <(echo "${{ steps.authors.outputs.all }}" | tr ',' '\n')
          declare -a m
          for id in "${ids[@]}"; do
            slack=$(jq -r --arg k "$id" '.[ $k ] // empty' .github/slack-user-map.json || true)
            if [[ -n "$slack" ]]; then
              m+=("<@$slack>")
            elif [[ "$id" == *"@"* ]]; then
              m+=("$(cut -d@ -f1 <<<"$id")")   # localâ€‘part fallback
            else
              m+=("$id")
            fi
          done
          echo "list=$(IFS=' '; echo "${m[*]}")" >>"$GITHUB_OUTPUT"

      # 5Â Â Send title / body / url to Slack â€” with DEBUG output
      - name: Notify Slack
        run: |
          set -euo pipefail

          body="ðŸ‘¥ *Please review*: ${{ steps.mentions.outputs.list }}"

          payload=$(jq -n \
            --arg title ":rocket: Develop â†’ Stage PR #${{ steps.pr.outputs.number }} created" \
            --arg body  "$body" \
            --arg url   "${{ steps.pr.outputs.url }}" \
            '{title:$title,body:$body,url:$url}')

          echo "=== Slack payload being sent ==="
          echo "$payload" | jq .
          echo "================================"

          # -f: fail on nonâ€‘200, -sS: silent but show errors, -w prints HTTP code
          curl -f -sS -X POST -H 'Content-Type: application/json' \
               --data "$payload" "$SLACK_RELEASE_WORKFLOW_URL" \
               -w '\nSlack responded with HTTP %{http_code}\n'

